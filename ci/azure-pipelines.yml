# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master
pr:
- master

jobs:
- job: Build_Ubuntu
  displayName: Build Ubuntu
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - bash: bash $(Build.SourcesDirectory)/ci/prepare_ubuntu_machine.sh && mkdir -p cmake-build && mkdir -p vcpkg-build
    displayName: 'Install Build Tools'
  - bash: bash $(Build.SourcesDirectory)/ci/build_linux.sh
    displayName: 'Build and Test Linux'
    workingDirectory: 'cmake-build'
  - bash: bash $(Build.SourcesDirectory)/ci/build_with_vcpkg.sh
    displayName: 'Build With Vcpkg'
    workingDirectory: 'vcpkg-build'
  - task: CopyFiles@2
    displayName: 'Copy Files to artifact staging directory'
    inputs:
      SourceFolder: 'cmake-build'
      Contents: 'stencil*.zip'
      TargetFolder: $(Build.ArtifactStagingDirectory)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)

- job: Build_VS2019_x64
  displayName: Build VS2019
  pool:
    vmImage: 'windows-2019'
  steps:
  - powershell: mkdir -p cmake-build ; mkdir -p vcpkg-build
  - task: Powershell@2
    displayName: "Build and Test VS2019"
    inputs:
      workingDirectory: 'cmake-build'
      targetType: 'filePath'
      filePath:  $(Build.SourcesDirectory)/ci/build_win_msvc_x64.ps1
  - task: Powershell@2
    displayName: "Build Windows with Vcpkg"
    inputs:
      workingDirectory: 'vcpkg-build'
      targetType: 'filePath'
      errorActionPreference: 'stop'
      failOnStderr: false
      filePath:  $(Build.SourcesDirectory)/ci/build_with_vcpkg_x64.ps1
  - task: CopyFiles@2
    displayName: 'Copy Files to artifact staging directory'
    inputs:
      SourceFolder: 'cmake-build'
      Contents: 'stencil*.zip'
      TargetFolder: $(Build.ArtifactStagingDirectory)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)


- job: Build_VS2019_x86
  displayName: Build VS2019
  pool:
    vmImage: 'windows-2019'
  steps:
  - powershell: mkdir -p cmake-build ; mkdir -p vcpkg-build
  - task: Powershell@2
    displayName: "Build and Test VS2019"
    inputs:
      workingDirectory: 'cmake-build'
      targetType: 'filePath'
      filePath:  $(Build.SourcesDirectory)/ci/build_win_msvc_x86.ps1
  - task: Powershell@2
    displayName: "Build Windows with Vcpkg"
    inputs:
      workingDirectory: 'vcpkg-build'
      targetType: 'filePath'
      errorActionPreference: 'stop'
      failOnStderr: false
      filePath:  $(Build.SourcesDirectory)/ci/build_with_vcpkg_x86.ps1
  - task: CopyFiles@2
    displayName: 'Copy Files to artifact staging directory'
    inputs:
      SourceFolder: 'cmake-build'
      Contents: 'stencil*.zip'
      TargetFolder: $(Build.ArtifactStagingDirectory)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
